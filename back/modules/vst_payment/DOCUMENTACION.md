# VST Payment Callback API - Документація

## Callback Endpoint - Статуси відповіді

### POST `/api/vst-success`

Endpoint для обробки callback-повідомлень від VST платіжного сервісу.

**Важливо розуміти:**
- VST відправляє на цей endpoint інформацію про статус платежу (успішний/неуспішний)
- Наш сервер лише підтверджує, що отримав це повідомлення і обробив його
- Рішення про успішність платежу приймає VST, ми лише реагуємо на їхнє повідомлення

---

## Структура відповіді

Callback завжди повертає JSON з полями:

```json
{
  "success": boolean,
  "processed": boolean,
  "message": string,
  ...
}
```

### Поля відповіді

- **`success`** - Чи вдалося технічно обробити callback на нашому сервері (запит валідний, БД доступна, тощо)
- **`processed`** - Чи був платіж фактично оброблений у нашій БД (борг зменшено / рахунок деактивовано)
- **`message`** - Текстове повідомлення про результат обробки callback

---

## ❓ Часті запитання (FAQ)

### Питання 1: Чи може `success` бути `false`? У яких випадках?

**Так, може.** `success: false` означає технічну помилку на нашому сервері при обробці callback:

| Випадок | HTTP статус | success | processed | Повторювати? |
|---------|-------------|---------|-----------|--------------|
| Відсутні обов'язкові поля (`payment_id`, `status`, `amount`) | 400 | false | - | ❌ НІ (помилка формату) |
| БД недоступна | 500 | false | - | ✅ ТАК (макс. 3-5 разів) |
| Платіж не знайдено в БД | 500 | false | - | ✅ ТАК (макс. 3-5 разів) |
| Помилка оновлення БД | 500 | false | - | ✅ ТАК (макс. 3-5 разів) |
| Внутрішня помилка сервера | 500 | false | - | ✅ ТАК (макс. 3-5 разів) |

**Коли повторювати:**
- **HTTP 500** → ✅ Так, повторити з експоненційною затримкою (30 сек, 1 хв, 5 хв)
- **HTTP 400** → ❌ Ні, це помилка формату даних, перевірте запит

---

### Питання 2: Чи може `processed` бути `false`? У яких випадках?

**Так, може.** `processed: false` означає, що платіж НЕ застосовано до БД, **але це нормально**:

| Випадок | HTTP статус | success | processed | Причина | Повторювати? |
|---------|-------------|---------|-----------|---------|--------------|
| VST відправив `status: "FAILED"` | 200 | true | false | Платіж не пройшов на стороні VST | ❌ НІ |
| VST відправив `status: "CANCELLED"` | 200 | true | false | Платіж скасовано користувачем | ❌ НІ |
| VST відправив `status: "PENDING"` | 200 | true | false | Платіж ще обробляється | ❌ НІ |
| VST відправив будь-який статус !== "SUCCESS" | 200 | true | false | Платіж не успішний | ❌ НІ |

**Важливо:** Якщо `success: true` і `processed: false` - це означає:
- ✅ Callback технічно доставлено і оброблено
- ✅ Наш сервер працює коректно
- ⚠️ Платіж не застосовано до БД, тому що VST повідомив про неуспішний статус
- ❌ **НЕ** потрібно повторювати - callback вже оброблено

---

### Питання 3: Що робити, якщо `success: false`?

**Відповідь залежить від HTTP статусу:**

#### Варіант A: HTTP 400 Bad Request + `success: false`
```json
{
  "success": false,
  "message": "Відсутні обов'язкові поля: payment_id, status, amount",
  "error": "MISSING_REQUIRED_FIELDS"
}
```

**Дії:**
1. ❌ **НЕ** повторювати запит з тими ж даними
2. Перевірити формат запиту
3. Перевірити, чи всі обов'язкові поля присутні
4. Виправити запит і відправити знову (якщо це можливо)
5. Зв'язатися з технічною підтримкою, якщо формат здається правильним

**Це НЕ відміна платежу, а помилка формату запиту!**

---

#### Варіант B: HTTP 500 Internal Server Error + `success: false`
```json
{
  "success": false,
  "message": "Помилка обробки платежу",
  "error": "БД недоступна"
}
```

**Дії:**
1. ✅ **МОЖНА** повторити запит з тими ж даними
2. Використати експоненційну затримку: 30 сек → 1 хв → 5 хв
3. Максимум 3-5 спроб
4. Після всіх спроб:
   - Зафіксувати, що callback не доставлено
   - Позначити транзакцію як "потребує ручної перевірки"
   - Сповістити технічну підтримку

**Це тимчасова технічна проблема, а НЕ відміна платежу!**

---

### Питання 4: Що означає "відміняти платіж" у контексті callback?

**Важливо розуміти:**

VST відправляє callback **ПІСЛЯ** того, як платіж вже має статус на вашій стороні:

- Якщо VST відправляє `status: "SUCCESS"` → платіж вже успішний на стороні VST
- Якщо VST відправляє `status: "FAILED"` → платіж вже відхилений на стороні VST
- Якщо VST відправляє `status: "CANCELLED"` → платіж вже скасований на стороні VST

**Наш сервер не приймає рішення про платіж**, він тільки:
1. Отримує повідомлення про статус від VST
2. Підтверджує отримання callback
3. Якщо статус `SUCCESS` - застосовує платіж до БД
4. Якщо статус інший - НЕ застосовує платіж до БД

**Отже, "відміняти платіж" на нашій стороні немає сенсу**, тому що:
- Рішення про успішність платежу вже прийняте на стороні VST
- Ми лише синхронізуємо цей статус зі своєю БД
- Якщо `processed: false` - платіж просто не застосується до БД (борг не списується)

---

### Питання 5: Коли повторювати callback, а коли ні? (Підсумкова таблиця)

| HTTP статус | success | processed | Що сталося | Повторювати? | Що робити |
|-------------|---------|-----------|------------|--------------|-----------|
| 200 | true | true | Callback доставлено, платіж застосовано | ❌ НІ | Зафіксувати доставку |
| 200 | true | false | Callback доставлено, платіж НЕ застосовано (статус !== SUCCESS) | ❌ НІ | Зафіксувати доставку |
| 400 | false | - | Невалідні дані у запиті | ❌ НІ | Перевірити формат |
| 500 | false | - | Технічна помилка сервера | ✅ ТАК (3-5 разів) | Retry з затримкою |
| Timeout | - | - | З'єднання втрачено | ✅ ТАК (3-5 разів) | Retry з затримкою |

**Коротко:**
- HTTP 200 (будь-який результат) → ❌ НЕ повторювати (callback доставлено)
- HTTP 400 → ❌ НЕ повторювати (помилка формату)
- HTTP 500 або Timeout → ✅ Повторювати (3-5 разів з затримкою)

---

## Можливі варіанти відповіді

### 1. ✅ Успішна обробка платежу

**Умови:**
- Всі обов'язкові поля присутні (`payment_id`, `status`, `amount`)
- Статус платежу = `SUCCESS`
- Платіж знайдено в БД
- Борг/рахунок успішно оновлено

**Відповідь:**
```json
{
  "success": true,
  "processed": true,
  "message": "Платіж успішно оброблений",
  "transaction_id": "f7c959c4-22bf-4f7b-8391-4b61fc23ea1f",
  "debtor": {
    "id": "3790336655873804148",
    "name": "Тестовий тест",
    "taxType": 1,
    "fieldUpdated": "residential_debt",
    "oldDebt": 2000,
    "paidAmount": 10,
    "newDebt": 1990
  }
}
```

**Статус код:** `200 OK`

**Дії платіжного сервісу:** ✅ Завершити транзакцію успішно

---

### 2. ⚠️ Callback отримано, але платіж не успішний (статус !== SUCCESS)

**Умови:**
- Всі обов'язкові поля присутні
- Статус платежу від VST НЕ `SUCCESS` (наприклад: `FAILED`, `CANCELLED`, `PENDING`)
- Callback технічно оброблено, але платіж НЕ застосовано до БД

**Відповідь:**
```json
{
  "success": true,
  "processed": false,
  "message": "Платіж не успішний. Статус: FAILED",
  "status": "FAILED"
}
```

**Статус код:** `200 OK`

**Що це означає:**
- ✅ Callback технічно отримано і оброблено (`success: true`)
- ❌ Платіж НЕ застосовано до БД, борг не списано (`processed: false`)
- VST повідомив про неуспішний платіж, ми підтверджуємо отримання цієї інформації

**Дії платіжного сервісу (VST):**
- ✅ Зафіксувати, що callback доставлено
- ❌ **НЕ** повторювати callback (він успішно доставлено)
- Транзакція вже має статус на вашій стороні (FAILED/CANCELLED/etc)

---

### 3. ❌ Відсутні обов'язкові поля

**Умови:**
- Відсутні поля `payment_id`, `status` або `amount`

**Відповідь:**
```json
{
  "success": false,
  "message": "Відсутні обов'язкові поля: payment_id, status, amount",
  "error": "MISSING_REQUIRED_FIELDS"
}
```

**Статус код:** `400 Bad Request`

**Дії платіжного сервісу:**
- ❌ **НЕ** повторювати запит з тими ж даними
- Перевірити формат запиту і виправити його

---

### 4. ❌ Помилка обробки платежу

**Умови:**
- Платіж з `payment_id` не знайдено в БД
- Помилка з'єднання з БД
- Інші серверні помилки

**Відповідь:**
```json
{
  "success": false,
  "message": "Помилка обробки платежу",
  "error": "Боржника з ID 123456789 не знайдено"
}
```

**Статус код:** `500 Internal Server Error`

**Дії платіжного сервісу:**
- ⚠️ **Можна** спробувати повторити запит (з експоненційною затримкою)
- Максимум 3-5 спроб з інтервалами: 30 сек, 1 хв, 5 хв
- Якщо всі спроби невдалі - зв'язатися з технічною підтримкою
- Помітити транзакцію як "потребує ручної перевірки"

---

## Блок-схема обробки відповіді (для VST)

```
VST відправив callback → Отримано відповідь
         │
         ├─→ HTTP status === 200 OK?
         │        │
         │        ├─→ success === true?
         │        │        │
         │        │        ├─→ processed === true?
         │        │        │        │
         │        │        │        └─→ ✅ CALLBACK ДОСТАВЛЕНО
         │        │        │             Платіж оброблено в БД
         │        │        │             Зафіксувати успішну доставку
         │        │        │             НЕ повторювати
         │        │        │
         │        │        └─→ processed === false?
         │        │             │
         │        │             └─→ ⚠️ CALLBACK ДОСТАВЛЕНО
         │        │                  Платіж НЕ оброблено (статус був не SUCCESS)
         │        │                  Зафіксувати доставку callback
         │        │                  НЕ повторювати
         │        │
         │        └─→ success === false?
         │             │
         │             ├─→ status === 400?
         │             │    └─→ ❌ НЕВАЛІДНИЙ ЗАПИТ
         │             │         Перевірити формат даних
         │             │         НЕ повторювати
         │             │
         │             └─→ status === 500?
         │                  └─→ ❌ СЕРВЕРНА ПОМИЛКА
         │                       Повторити (макс. 3-5 разів)
         │                       Експоненційна затримка
         │
         └─→ Помилка з'єднання (timeout)?
              └─→ ❌ TIMEOUT / NO CONNECTION
                   Повторити (макс. 3-5 разів)
                   Експоненційна затримка
```

---

## Рекомендації для інтеграції

### Повторні спроби (Retry Logic)

**Коли повторювати:**
- ✅ HTTP 500 (Internal Server Error)
- ✅ HTTP 502, 503, 504 (Gateway/Service errors)
- ✅ Timeout / Connection errors

**Коли НЕ повторювати:**
- ❌ HTTP 200 з `processed: false` (платіж не успішний)
- ❌ HTTP 400 (Bad Request - невалідні дані)
- ❌ HTTP 401, 403 (проблеми авторизації)
- ❌ HTTP 404 (endpoint не знайдено)

### Стратегія повторів (Exponential Backoff)

```javascript
// Приклад стратегії повторів для VST
const retryDelays = [30000, 60000, 300000]; // 30сек, 1хв, 5хв
let attempt = 0;

async function sendCallback(paymentData, transactionStatus) {
  try {
    const response = await fetch('/api/vst-success', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        transaction_id: paymentData.transaction_id,
        payment_id: paymentData.payment_id,
        status: transactionStatus, // 'SUCCESS', 'FAILED', etc - з вашої системи
        amount: paymentData.amount,
        timestamp: new Date().toISOString(),
        // ... інші поля
      })
    });

    if (response.status === 500 && attempt < retryDelays.length) {
      // Серверна помилка - повторити через затримку
      console.log(`Server error, retrying in ${retryDelays[attempt]}ms...`);
      setTimeout(() => {
        attempt++;
        sendCallback(paymentData, transactionStatus);
      }, retryDelays[attempt]);

    } else if (response.status === 200) {
      const result = await response.json();

      if (result.success && result.processed) {
        // ✅ Callback доставлено, платіж оброблено в їхній БД
        console.log('✅ Callback delivered successfully, payment processed in partner DB');
        markCallbackAsDelivered(paymentData.transaction_id);

      } else if (result.success && !result.processed) {
        // ⚠️ Callback доставлено, але платіж не оброблено
        // (це нормально якщо ми відправили статус FAILED/CANCELLED)
        console.log('⚠️ Callback delivered, but payment not processed (status was not SUCCESS)');
        markCallbackAsDelivered(paymentData.transaction_id);
      }

    } else if (response.status === 400) {
      // Невалідний запит - не повторювати
      console.error('❌ Invalid request format, check the data');
      markCallbackAsFailed(paymentData.transaction_id, 'Invalid request format');
    }

  } catch (error) {
    // Помилка з'єднання - повторити
    console.error(`Connection error: ${error.message}`);
    if (attempt < retryDelays.length) {
      setTimeout(() => {
        attempt++;
        sendCallback(paymentData, transactionStatus);
      }, retryDelays[attempt]);
    } else {
      console.error('❌ Max retry attempts reached, manual check required');
      markCallbackAsRequiresManualCheck(paymentData.transaction_id);
    }
  }
}

// Функції для позначення статусу доставки callback на вашій стороні
function markCallbackAsDelivered(transactionId) {
  // Зберегти у вашій БД, що callback доставлено партнеру
}

function markCallbackAsFailed(transactionId, reason) {
  // Зберегти у вашій БД, що callback не вдалося доставити
}

function markCallbackAsRequiresManualCheck(transactionId) {
  // Позначити транзакцію для ручної перевірки
}
```

---

## Приклади сценаріїв

### Сценарій 1: Успішний платіж
1. Користувач успішно оплатив податок на VST
2. VST відправляє callback з `status: "SUCCESS"`
3. Наш сервер:
   - Отримує callback
   - Перевіряє статус = SUCCESS
   - Оновлює БД (зменшує борг)
   - Повертає `{ success: true, processed: true }`
4. VST фіксує, що callback доставлено

**Результат:** ✅ Платіж застосовано, callback доставлено

---

### Сценарій 2: Неуспішний платіж
1. Користувач почав оплату, але вона не пройшла (недостатньо коштів, помилка карти, тощо)
2. VST відправляє callback з `status: "FAILED"`
3. Наш сервер:
   - Отримує callback
   - Перевіряє статус = FAILED
   - **НЕ** оновлює БД (борг залишається)
   - Повертає `{ success: true, processed: false }`
4. VST фіксує, що callback доставлено

**Результат:** ⚠️ Платіж не застосовано (це нормально), callback доставлено

---

### Сценарій 3: Технічна помилка на нашому сервері
1. Користувач успішно оплатив
2. VST відправляє callback з `status: "SUCCESS"`
3. Наш сервер:
   - Отримує callback
   - Намагається оновити БД
   - **БД недоступна або помилка з'єднання**
   - Повертає `{ success: false, error: "..." }` + HTTP 500
4. VST отримує помилку 500
5. VST повторює callback через 30 секунд
6. При повторній спробі БД доступна, платіж застосовується
7. Повертаємо `{ success: true, processed: true }`

**Результат:** ✅ Платіж застосовано після повторної спроби

---

### Сценарій 4: Невалідні дані від VST
1. VST відправляє callback без обов'язкового поля `payment_id`
2. Наш сервер:
   - Валідує запит
   - Виявляє відсутнє поле
   - Повертає `{ success: false, error: "MISSING_REQUIRED_FIELDS" }` + HTTP 400
3. VST отримує помилку 400
4. VST **НЕ** повторює callback (це помилка формату)
5. VST фіксує проблему і сповіщає технічну підтримку

**Результат:** ❌ Callback не доставлено, потрібна перевірка формату

---

## Контакти

При виникненні питань або проблем звертайтесь до технічної підтримки:
- Email: support@example.com
- Документація: [README.md](./README.md)
